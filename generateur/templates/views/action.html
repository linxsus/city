<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Générateur de Classes</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .code-editor {
            width: 100%;
            min-height: 150px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background-color: var(--color-bg);
            color: var(--color-text);
            resize: vertical;
        }

        .code-editor:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .param-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: var(--spacing-sm);
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .param-row input {
            padding: var(--spacing-sm);
        }

        .btn-remove {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .help-text {
            font-size: 0.85em;
            color: var(--color-text-muted);
            margin-top: 4px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        /* Styles pour le sélecteur d'erreurs */
        .erreur-selector {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            max-height: 250px;
            overflow-y: auto;
            background: var(--color-bg);
        }

        .erreur-category {
            border-bottom: 1px solid var(--color-border);
        }

        .erreur-category:last-child {
            border-bottom: none;
        }

        .erreur-category-header {
            padding: var(--spacing-sm);
            background: var(--color-surface);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .erreur-category-header:hover {
            background: var(--color-surface-hover);
        }

        .erreur-category-header .toggle-icon {
            transition: transform 0.2s;
        }

        .erreur-category.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .erreur-category.collapsed .erreur-list {
            display: none;
        }

        .erreur-list {
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        .erreur-item {
            display: flex;
            align-items: flex-start;
            padding: var(--spacing-xs) 0;
            gap: var(--spacing-sm);
        }

        .erreur-item input[type="checkbox"] {
            margin-top: 3px;
            flex-shrink: 0;
        }

        .erreur-info {
            flex: 1;
        }

        .erreur-name {
            font-weight: 500;
            color: var(--color-text);
        }

        .erreur-message {
            font-size: 0.85em;
            color: var(--color-text-muted);
        }

        .erreur-badge {
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            background: var(--color-primary);
            color: white;
            margin-left: var(--spacing-xs);
        }

        .erreur-badge.retry {
            background: var(--color-warning);
        }

        .selected-erreurs {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .selected-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 0.85em;
        }

        .selected-tag .remove-tag {
            margin-left: 6px;
            cursor: pointer;
            opacity: 0.8;
        }

        .selected-tag .remove-tag:hover {
            opacity: 1;
        }

        .erreur-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .erreur-actions button {
            font-size: 0.85em;
            padding: var(--spacing-xs) var(--spacing-sm);
        }
    </style>
</head>
<body>
    {% include "partials/header.html" %}

    <main class="container">
        <div class="page-header">
            <h1>Créer une Action Simple</h1>
            <p>Définissez une action atomique personnalisée</p>
        </div>

        <div class="content-grid">
            <!-- Formulaire -->
            <section class="form-section">
                <form id="action-form">
                    <!-- Informations de base -->
                    <div class="form-card">
                        <h3>Informations de base</h3>

                        <div class="form-group">
                            <label for="nom">Nom de l'action *</label>
                            <input type="text" id="nom" name="nom"
                                   placeholder="ex: cliquer_position"
                                   pattern="^[a-z][a-z0-9_]*$"
                                   required>
                            <span class="help-text">Nom en snake_case (ex: mon_action)</span>
                        </div>

                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="2"
                                      placeholder="Description de ce que fait l'action"></textarea>
                        </div>
                    </div>

                    <!-- Paramètres du constructeur -->
                    <div class="form-card">
                        <div class="section-header">
                            <h3>Paramètres du constructeur</h3>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addParameter()">+ Ajouter</button>
                        </div>
                        <p class="help-text">Paramètres supplémentaires pour le __init__ (fenetre est automatique)</p>

                        <div id="params-container">
                            <!-- Paramètres dynamiques -->
                        </div>
                    </div>

                    <!-- Condition (optionnelle) -->
                    <div class="form-card">
                        <h3>Condition (optionnelle)</h3>
                        <p class="help-text">Code Python retournant True/False. Utilisez self.fenetre pour accéder à la fenêtre.</p>

                        <textarea id="condition-code" class="code-editor"
                                  placeholder="# Exemple:
# return self.fenetre.detect_image('template.png')
# ou
# return True"></textarea>
                    </div>

                    <!-- Code _run() -->
                    <div class="form-card">
                        <h3>Code d'exécution (_run) *</h3>
                        <p class="help-text">Code Python à exécuter. Doit retourner True (succès) ou False (échec).</p>

                        <textarea id="run-code" class="code-editor" required
                                  placeholder="# Exemple:
# x, y = self.position
# self.fenetre.click_at(x, y)
# return True"></textarea>
                    </div>

                    <!-- Gestion des erreurs -->
                    <div class="form-card">
                        <div class="section-header">
                            <h3>Gestion des erreurs (optionnel)</h3>
                            <div style="display: flex; gap: var(--spacing-sm);">
                                <button type="button" class="btn btn-primary btn-sm" onclick="suggestErreursIA()" title="Suggérer les erreurs pertinentes via l'IA">Suggestion IA</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="openCreateErreurModal()">+ Nouvelle erreur</button>
                            </div>
                        </div>

                        <!-- Erreurs à vérifier après succès -->
                        <div class="form-group">
                            <label>Erreurs à vérifier après succès</label>
                            <span class="help-text">Ces erreurs sont vérifiées après chaque exécution réussie (popups intempestifs, etc.)</span>
                            <div class="erreur-actions">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="loadDefaultErreursApres()">Charger défauts</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearErreursApres()">Effacer</button>
                            </div>
                            <div class="erreur-selector" id="erreurs-apres-selector">
                                <p class="help-text" style="padding: var(--spacing-sm);">Chargement des erreurs...</p>
                            </div>
                            <div class="selected-erreurs" id="erreurs-apres-selected"></div>
                        </div>

                        <!-- Erreurs à vérifier si échec -->
                        <div class="form-group">
                            <label>Erreurs à vérifier si échec</label>
                            <span class="help-text">Ces erreurs sont vérifiées si l'action échoue (manque de ressources, etc.)</span>
                            <div class="erreur-actions">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="loadDefaultErreursEchec()">Charger défauts</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearErreursEchec()">Effacer</button>
                            </div>
                            <div class="erreur-selector" id="erreurs-echec-selector">
                                <p class="help-text" style="padding: var(--spacing-sm);">Chargement des erreurs...</p>
                            </div>
                            <div class="selected-erreurs" id="erreurs-echec-selected"></div>
                        </div>

                        <!-- Option retry si erreur non identifiée -->
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="retry-si-erreur-non-identifiee">
                                Réessayer si erreur non identifiée
                            </label>
                            <span class="help-text">Si l'action échoue sans erreur identifiée, réessayer automatiquement</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="previewCode()">Prévisualiser</button>
                        <button type="submit" class="btn btn-primary">Générer</button>
                    </div>
                </form>
            </section>

            <!-- Prévisualisation -->
            <aside class="preview-section">
                <div class="preview-card">
                    <h3>Prévisualisation du code</h3>
                    <div class="preview-filename" id="preview-filename">action_*.py</div>
                    <pre class="code-preview" id="code-preview"><code>Le code généré apparaîtra ici...</code></pre>
                </div>
            </aside>
        </div>

        <!-- Modal résultat -->
        <div class="modal hidden" id="result-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="result-title">Résultat</h3>
                    <button class="modal-close" onclick="closeResultModal()">&times;</button>
                </div>
                <div id="result-body"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeResultModal()">OK</button>
                </div>
            </div>
        </div>

        <!-- Modal création d'erreur -->
        <div class="modal hidden" id="create-erreur-modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Créer une nouvelle erreur</h3>
                    <button class="modal-close" onclick="closeCreateErreurModal()">&times;</button>
                </div>
                <form id="create-erreur-form" onsubmit="submitCreateErreur(event)">
                    <div class="form-group">
                        <label for="erreur-nom">Nom de l'erreur *</label>
                        <input type="text" id="erreur-nom" name="nom"
                               placeholder="ex: popup_maintenance"
                               pattern="^[a-z][a-z0-9_]*$"
                               required>
                        <span class="help-text">Nom en snake_case</span>
                    </div>

                    <div class="form-group">
                        <label for="erreur-type">Type de détection *</label>
                        <select id="erreur-type" name="type" required onchange="toggleErreurTypeFields()">
                            <option value="image">Image (template)</option>
                            <option value="texte">Texte (OCR)</option>
                        </select>
                    </div>

                    <div class="form-group" id="erreur-image-group">
                        <label for="erreur-image">Chemin de l'image *</label>
                        <input type="text" id="erreur-image" name="image"
                               placeholder="ex: popup_maintenance.png">
                        <span class="help-text">Nom du fichier dans templates/popups/</span>
                    </div>

                    <div class="form-group hidden" id="erreur-texte-group">
                        <label for="erreur-texte">Texte à détecter *</label>
                        <input type="text" id="erreur-texte" name="texte"
                               placeholder="ex: Maintenance en cours">
                    </div>

                    <div class="form-group">
                        <label for="erreur-message">Message descriptif *</label>
                        <input type="text" id="erreur-message" name="message"
                               placeholder="ex: Popup de maintenance"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="erreur-categorie">Catégorie</label>
                        <select id="erreur-categorie" name="categorie">
                            <option value="connexion">Connexion</option>
                            <option value="jeu">Jeu</option>
                            <option value="popup" selected>Popup / Publicité</option>
                            <option value="systeme">Système</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="erreur-priorite">Priorité</label>
                        <input type="number" id="erreur-priorite" name="priorite"
                               value="50" min="0" max="100">
                        <span class="help-text">0-100 (plus élevé = vérifié en premier)</span>
                    </div>

                    <div class="form-group">
                        <label for="erreur-action">Action de correction</label>
                        <select id="erreur-action" name="action_correction">
                            <option value="">Aucune</option>
                            <option value="_creer_action_clic_ok(fenetre)">Cliquer OK</option>
                            <option value="_creer_action_fermer_popup(fenetre)">Fermer popup</option>
                            <option value="_creer_action_clic_plus_tard(fenetre)">Cliquer Plus tard</option>
                            <option value="_creer_action_attendre(fenetre)">Attendre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="erreur-retry" name="retry">
                            Réessayer l'action originale après correction
                        </label>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateErreurModal()">Annuler</button>
                        <button type="submit" class="btn btn-primary">Créer</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    {% include "partials/footer.html" %}

    <script src="/static/js/app.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/views/action-view.js"></script>
</body>
</html>
