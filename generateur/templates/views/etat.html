<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - G√©n√©rateur de Classes</title>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    {% include "partials/header.html" %}

    <main class="container">
        <div class="page-header">
            <h1>Cr√©er un √âtat</h1>
            <p>D√©finissez un √©cran ou une situation d√©tectable dans le jeu</p>
        </div>

        <form id="etat-form" class="form-grid">
            <!-- Section Upload Image -->
            <section class="form-section">
                <h2>1. Image Source</h2>

                <div class="upload-zone" id="upload-zone">
                    <input type="file" id="image-input" accept="image/png,image/jpeg" hidden>
                    <div class="upload-content">
                        <span class="upload-icon">üì∑</span>
                        <p>Glissez une image ici ou <button type="button" class="btn-link" onclick="document.getElementById('image-input').click()">parcourez</button></p>
                        <small>PNG ou JPG, max 10 Mo</small>
                        <div class="upload-separator">
                            <span>ou</span>
                        </div>
                        <button type="button" class="btn btn-primary" id="btn-capture-android">
                            üì± Capturer depuis Android
                        </button>
                        <div id="capture-status" class="capture-status hidden"></div>
                    </div>
                </div>

                <div id="image-preview-container" class="hidden">
                    <div class="image-editor" id="image-editor">
                        <canvas id="image-canvas"></canvas>
                    </div>
                    <div class="editor-toolbar">
                        <button type="button" class="btn btn-secondary" id="btn-reset-selection">R√©initialiser</button>
                        <button type="button" class="btn btn-secondary" id="btn-new-capture">üì± Nouvelle capture</button>
                        <button type="button" class="btn btn-secondary" id="btn-save-template">üíæ Sauver template</button>
                        {% if claude_available %}
                        <button type="button" class="btn btn-primary" id="btn-suggest-ia">ü§ñ Suggestions IA</button>
                        {% endif %}
                    </div>
                </div>

                <input type="hidden" name="image_source" id="image-source">
                <input type="hidden" name="region_x" id="region-x">
                <input type="hidden" name="region_y" id="region-y">
                <input type="hidden" name="region_width" id="region-width">
                <input type="hidden" name="region_height" id="region-height">
            </section>

            <!-- Section Configuration -->
            <section class="form-section">
                <h2>2. Configuration</h2>

                <div class="form-group">
                    <label for="nom">Nom de l'√©tat <span class="required">*</span></label>
                    <input type="text" id="nom" name="nom" required
                           pattern="^[a-z][a-z0-9_]*$"
                           placeholder="ex: ville_principale"
                           title="Lettres minuscules, chiffres et underscores uniquement">
                    <small class="form-help">Format snake_case (ex: popup_connexion)</small>
                </div>

                <div class="form-group">
                    <label for="methode-verif">M√©thode de v√©rification</label>
                    <select id="methode-verif" name="methode_verif">
                        <option value="image">Image seule</option>
                        <option value="texte">Texte seul (OCR)</option>
                        <option value="combinaison">Image ET Texte</option>
                    </select>
                </div>

                <div class="form-group" id="texte-ocr-group" style="display: none;">
                    <label for="texte-ocr">Texte √† d√©tecter</label>
                    <input type="text" id="texte-ocr" name="texte_ocr"
                           placeholder="ex: Menu Principal">
                </div>

                <div class="form-group">
                    <label for="groupes">Groupes</label>
                    <div class="tags-input" id="groupes-container">
                        <input type="text" id="groupes-input" placeholder="Ajouter un groupe...">
                    </div>
                    <input type="hidden" name="groupes" id="groupes">
                    <small class="form-help">Groupes sugg√©r√©s: <span id="groupes-suggestions"></span></small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="priorite">Priorit√©</label>
                        <input type="number" id="priorite" name="priorite"
                               value="0" min="-100" max="100">
                        <small class="form-help">0=normal, 80-100=popup</small>
                    </div>

                    <div class="form-group">
                        <label for="threshold">Seuil de d√©tection</label>
                        <input type="range" id="threshold" name="threshold"
                               value="0.8" min="0.5" max="1.0" step="0.05">
                        <output for="threshold" id="threshold-value">0.80</output>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Description (optionnel)</label>
                    <textarea id="description" name="description" rows="2"
                              placeholder="Description de cet √©tat..."></textarea>
                </div>
            </section>

            <!-- Section Pr√©visualisation -->
            <section class="form-section full-width">
                <h2>3. Pr√©visualisation</h2>

                <div class="preview-container">
                    <div class="preview-header">
                        <span class="preview-filename" id="preview-filename">etat_xxx.py</span>
                        <button type="button" class="btn btn-secondary btn-small" id="btn-preview">
                            Actualiser
                        </button>
                    </div>
                    <pre class="code-preview" id="code-preview"><code>// Le code sera affich√© ici apr√®s configuration</code></pre>
                </div>
            </section>

            <!-- Actions -->
            <section class="form-actions full-width">
                <button type="button" class="btn btn-secondary" id="btn-validate">Valider</button>
                <button type="submit" class="btn btn-primary" id="btn-generate">G√©n√©rer le code</button>
            </section>
        </form>

        <!-- Modal r√©sultat -->
        <div class="modal hidden" id="result-modal">
            <div class="modal-content">
                <h3 id="result-title">R√©sultat</h3>
                <div id="result-body"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal()">Fermer</button>
                </div>
            </div>
        </div>

        <!-- Modal sauvegarde template -->
        <div class="modal hidden" id="template-modal">
            <div class="modal-content">
                <h3>Sauvegarder comme template</h3>
                <p class="form-help">Sauvegarde la s√©lection actuelle comme template r√©utilisable.</p>
                <div class="form-group">
                    <label for="template-name">Nom du template</label>
                    <input type="text" id="template-name" placeholder="ex: bouton_menu" pattern="^[a-z][a-z0-9_]*$">
                    <small class="form-help">Format snake_case</small>
                </div>
                <div class="form-group">
                    <label for="template-subdir">Sous-dossier</label>
                    <input type="text" id="template-subdir" value="scrcpy" placeholder="ex: scrcpy">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">Annuler</button>
                    <button type="button" class="btn btn-primary" id="btn-confirm-template">Sauvegarder</button>
                </div>
            </div>
        </div>
    </main>

    <style>
        .upload-separator {
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .upload-separator::before,
        .upload-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }
        .upload-separator span {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        .capture-status {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .capture-status.connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        .capture-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }
        .editor-toolbar {
            flex-wrap: wrap;
        }
    </style>

    {% include "partials/footer.html" %}

    <script src="/static/js/app.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/components/image-editor.js"></script>
    <script src="/static/js/views/etat-view.js"></script>
</body>
</html>
